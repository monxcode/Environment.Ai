<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGuard // Safety OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;600;800&display=swap');
        
        :root {
            --neon-emerald: #10b981;
            --neon-purple: #8b5cf6;
            --bg-dark: #09090b;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: #fafafa;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, .font-heading {
            font-family: 'Space Grotesk', sans-serif;
        }

        .bento-card {
            background: rgba(24, 24, 27, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bento-card:hover {
            border-color: rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .neon-text {
            text-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }

        .search-ring:focus-within {
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }

        .alert-shimmer {
            background: linear-gradient(90deg, #ef4444 0%, #7f1d1d 50%, #ef4444 100%);
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            to { background-position: 200% center; }
        }

        .loader-dots span {
            animation: bounce 0.6s infinite alternate;
        }
        .loader-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loader-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            to { transform: translateY(-4px); opacity: 0.5; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        .ai-glow {
            box-shadow: inset 0 0 20px rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        /* Suggestion Dropdown Styling */
        #suggestions {
            scrollbar-width: none;
        }
        #suggestions::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="selection:bg-emerald-500/30">

    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-emerald-900/20 blur-[120px] rounded-full z-[-1]"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/10 blur-[120px] rounded-full z-[-1]"></div>

    <div class="max-w-6xl mx-auto px-6 py-10">
        <!-- Navigation -->
        <nav class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center shadow-[0_0_20px_rgba(16,185,129,0.4)]">
                    <i class="fas fa-bolt-lightning text-zinc-950 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">EcoGuard <span class="text-emerald-500">v2.5</span></h1>
                    <p class="text-xs text-zinc-500 font-medium tracking-widest uppercase">Safety OS // Gemini AI</p>
                </div>
            </div>

            <div class="flex items-center gap-3 w-full md:w-auto relative">
                <div class="relative flex-1 md:flex-none search-ring rounded-2xl bg-zinc-900/50 border border-zinc-800 backdrop-blur-md overflow-hidden transition-all">
                    <input type="text" id="cityInput" autocomplete="off" placeholder="Locate city..." 
                        class="bg-transparent px-5 py-4 w-full md:w-72 outline-none text-sm placeholder:text-zinc-600">
                </div>
                <!-- Suggestions Dropdown -->
                <div id="suggestions" class="absolute top-full left-0 w-full md:w-72 mt-2 bg-zinc-900/90 border border-zinc-800 backdrop-blur-xl rounded-2xl shadow-2xl z-[100] hidden max-h-60 overflow-y-auto">
                    <!-- Dynamic Items -->
                </div>
                
                <button onclick="getWeather()" id="searchBtn"
                    class="bg-emerald-500 hover:bg-emerald-400 text-zinc-950 font-bold px-6 py-4 rounded-2xl transition-all shadow-[0_0_20px_rgba(16,185,129,0.2)] active:scale-95 flex items-center gap-2">
                    <i class="fas fa-location-arrow text-xs"></i>
                    <span id="btnText">Track</span>
                    <div id="loader" class="loader-dots hidden flex gap-1">
                        <span class="w-1.5 h-1.5 bg-zinc-950 rounded-full"></span>
                        <span class="w-1.5 h-1.5 bg-zinc-950 rounded-full"></span>
                        <span class="w-1.5 h-1.5 bg-zinc-950 rounded-full"></span>
                    </div>
                </button>
            </div>
        </nav>

        <!-- Main Dashboard -->
        <main id="mainGrid" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <!-- Main Weather Hero -->
                <div class="md:col-span-8 bento-card p-8 flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 text-zinc-400 mb-2">
                            <i class="fas fa-map-marker-alt text-emerald-500"></i>
                            <span id="locationName" class="font-medium tracking-wider">---</span>
                        </div>
                        <h2 id="tempValue" class="text-8xl md:text-9xl font-extrabold tracking-tighter neon-text mb-4">--°</h2>
                        <div class="flex items-center gap-3">
                            <span id="conditionValue" class="px-4 py-1.5 bg-zinc-800 rounded-full text-xs font-bold uppercase tracking-wider text-emerald-400 border border-emerald-500/20">--</span>
                            <span id="currentDate" class="text-zinc-500 text-xs font-medium">---</span>
                        </div>
                    </div>
                    <div id="weatherIcon" class="text-[12rem] text-zinc-800/50 absolute right-[-2rem] bottom-[-2rem] md:static md:text-9xl transition-all duration-1000">
                        <i class="fas fa-cloud"></i>
                    </div>
                </div>

                <!-- Safety Index Meter -->
                <div class="md:col-span-4 bento-card p-8 flex flex-col items-center justify-center text-center">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-zinc-500 mb-6">Safety Index</h3>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="70" fill="transparent" stroke="#18181b" stroke-width="12"></circle>
                            <circle id="scoreRing" cx="80" cy="80" r="70" fill="transparent" stroke="#10b981" stroke-width="12" 
                                stroke-dasharray="440" stroke-dashoffset="440" stroke-linecap="round" class="transition-all duration-1000"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="scoreText" class="text-4xl font-bold">--</span>
                            <span class="text-[10px] text-zinc-500 font-bold uppercase">Safe Range</span>
                        </div>
                    </div>
                    <p id="safetyLevel" class="mt-6 text-sm font-medium text-emerald-500">Calculating risk vectors...</p>
                </div>

                <!-- AI ADVISOR BENTO -->
                <div class="md:col-span-12 bento-card p-8 ai-glow relative overflow-hidden">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative z-10">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl bg-purple-500/20 flex items-center justify-center text-purple-400 border border-purple-500/30">
                                <i class="fas fa-brain-circuit text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-purple-400">AI Strategic Advisor</h3>
                                <p class="text-xs text-zinc-500 font-medium tracking-widest uppercase">Protocol Optimization Engine</p>
                            </div>
                        </div>
                        <div id="aiLoader" class="hidden flex items-center gap-3">
                            <span class="text-xs text-purple-500 font-bold animate-pulse">ANALYZING SIGNAL...</span>
                        </div>
                    </div>
                    <div id="aiMessageContainer" class="mt-8 p-6 bg-zinc-950/40 rounded-2xl border border-zinc-800/50">
                        <p id="aiContent" class="text-zinc-300 text-lg leading-relaxed font-medium">Awaiting sensor data to initialize AI advisory...</p>
                    </div>
                </div>

                <!-- AQI Monitor -->
                <div class="md:col-span-4 bento-card p-6 border-l-4 border-l-purple-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400">
                            <i class="fas fa-mask-face"></i>
                        </div>
                        <span id="aqiStatus" class="text-[10px] font-black uppercase bg-zinc-800 text-zinc-400 px-2 py-1 rounded">--</span>
                    </div>
                    <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest">Air Quality Index</p>
                    <h4 id="aqiValue" class="text-3xl font-bold mt-1 tracking-tight">--</h4>
                    <p class="text-[11px] text-zinc-500 mt-2 leading-relaxed" id="aqiDesc">Air concentration data syncing...</p>
                </div>

                <!-- Dynamic Alert Box -->
                <div id="alertBox" class="md:col-span-8 hidden">
                    <div class="alert-shimmer p-[2px] rounded-3xl h-full">
                        <div class="bg-zinc-950 rounded-[22px] p-6 flex flex-col md:flex-row items-center justify-between gap-6 h-full">
                            <div class="flex items-center gap-6">
                                <div class="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center shrink-0">
                                    <i class="fas fa-triangle-exclamation text-red-500 text-2xl"></i>
                                </div>
                                <div>
                                    <h4 id="alertTitle" class="text-lg font-bold text-red-500 uppercase">Alert Detected</h4>
                                    <p id="alertDesc" class="text-zinc-400 text-sm">Critical environment anomaly identified.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Stats -->
                <div class="md:col-span-4 bento-card p-6 flex items-center gap-5">
                    <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400">
                        <i class="fas fa-droplet"></i>
                    </div>
                    <div>
                        <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest">Humidity</p>
                        <h4 id="humidityValue" class="text-xl font-bold">--%</h4>
                    </div>
                </div>

                <div class="md:col-span-4 bento-card p-6 flex items-center gap-5">
                    <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-400">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div>
                        <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest">Wind Flow</p>
                        <h4 id="windValue" class="text-xl font-bold">-- km/h</h4>
                    </div>
                </div>

                <div class="md:col-span-4 bento-card p-6 flex items-center gap-5">
                    <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest">Visibility</p>
                        <h4 id="visibilityValue" class="text-xl font-bold">-- km</h4>
                    </div>
                </div>

            </div>
        </main>

        <!-- Initial State -->
        <div id="emptyState" class="flex flex-col items-center justify-center py-32 text-center">
            <div class="w-32 h-32 bg-zinc-900 rounded-[3rem] flex items-center justify-center mb-8 border border-zinc-800 relative">
                <i class="fas fa-radar text-4xl text-zinc-700 animate-pulse"></i>
                <div class="absolute inset-0 border-2 border-emerald-500/20 rounded-[3rem] animate-ping"></div>
            </div>
            <h2 class="text-2xl font-bold mb-2 tracking-tight">Awaiting Signal</h2>
            <p class="text-zinc-500 text-sm max-w-xs">Enter a global location to initialize multi-spectrum monitoring.</p>
        </div>
    </div>

    <div id="errorBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-red-500 text-zinc-950 font-bold px-8 py-4 rounded-2xl shadow-2xl hidden z-50 flex items-center gap-3">
        <i class="fas fa-circle-xmark"></i>
        <span id="errorMsg">Signal Lost.</span>
    </div>

    <script>
        const WEATHER_KEY = "e0e63578e29f0d3ac7359000742b5c8f"; 
        const API_KEY = ""; // Managed by environment
        const FALLBACK_KEY = "AIzaSyA199NrJ6SjElZ_7vLD1tCLs4EhRHmHpSE";

        const cityInput = document.getElementById('cityInput');
        const suggestionsBox = document.getElementById('suggestions');
        const loader = document.getElementById('loader');
        const btnText = document.getElementById('btnText');
        const searchBtn = document.getElementById('searchBtn');

        let debounceTimer;

        // --- Auto-Suggestion Logic ---
        cityInput.addEventListener('input', () => {
            const query = cityInput.value.trim();
            clearTimeout(debounceTimer);
            
            if (query.length < 3) {
                suggestionsBox.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${query}&limit=5&appid=${WEATHER_KEY}`);
                    const data = await res.json();
                    
                    if (data && data.length > 0) {
                        renderSuggestions(data);
                    } else {
                        suggestionsBox.classList.add('hidden');
                    }
                } catch (err) {
                    console.error("Suggestion Error", err);
                }
            }, 300);
        });

        function renderSuggestions(cities) {
            suggestionsBox.innerHTML = '';
            cities.forEach(city => {
                const item = document.createElement('div');
                item.className = "px-5 py-3 hover:bg-emerald-500/10 cursor-pointer transition-colors border-b border-zinc-800/50 last:border-0 flex flex-col";
                item.innerHTML = `
                    <span class="text-sm font-bold text-zinc-100">${city.name}</span>
                    <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-tighter">${city.state ? city.state + ', ' : ''}${city.country}</span>
                `;
                item.onclick = () => {
                    cityInput.value = `${city.name}, ${city.country}`;
                    suggestionsBox.classList.add('hidden');
                    getWeather();
                };
                suggestionsBox.appendChild(item);
            });
            suggestionsBox.classList.remove('hidden');
        }

        // Close suggestions on outside click
        document.addEventListener('click', (e) => {
            if (!cityInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });

        cityInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                suggestionsBox.classList.add('hidden');
                getWeather(); 
            }
        });

        // --- Existing Core Logic ---

        async function fetchAIAdvice(weather, aqi) {
            const aiLoader = document.getElementById('aiLoader');
            const aiContent = document.getElementById('aiContent');
            aiLoader.classList.remove('hidden');
            aiContent.innerText = "Analyzing environmental vectors...";

            const key = API_KEY || FALLBACK_KEY;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            const prompt = `System Data: Location ${weather.name}, Temp ${weather.main.temp}C, Wind ${weather.wind.speed}m/s, AQI Level ${aqi.list[0].main.aqi} (1-5 scale). 
            Task: Provide a short, ultra-clean, 2-sentence safety protocol for this specific environment. 
            Security: Remove all unwanted symbols, bullets, or markdown. Output plain text only. Be direct.`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "You are the EcoGuard AI Advisor. Use zero symbols or markdown. Deliver clean, professional safety advice." }] }
                    })
                });
                
                const data = await response.json();
                let advice = data.candidates?.[0]?.content?.parts?.[0]?.text || "Environment stable. Proceed with standard protocols.";
                aiContent.innerText = advice.replace(/[\*\#\-\_\>\n]/g, '').trim();
            } catch (err) {
                aiContent.innerText = "Error syncing with AI satellite. Follow standard safety procedures.";
            } finally {
                aiLoader.classList.add('hidden');
            }
        }

        async function getWeather() {
            const city = cityInput.value.trim();
            if (!city) { showError("Identity required."); return; }

            toggleLoading(true);
            hideError();

            try {
                const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${WEATHER_KEY}`);
                const geoData = await geoRes.json();
                if (geoData.length === 0) throw new Error("Null coordinate result.");

                const { lat, lon, name, country } = geoData[0];
                const [wRes, aRes] = await Promise.all([
                    fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_KEY}`),
                    fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${WEATHER_KEY}`)
                ]);

                const wData = await wRes.json();
                const aData = await aRes.json();

                updateUI(wData, name, country);
                updateAQI(aData);
                processSafetyScore(wData, aData);
                fetchAIAdvice(wData, aData);

            } catch (err) {
                showError(err.message);
            } finally {
                toggleLoading(false);
            }
        }

        function updateUI(data, cityName, country) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainGrid').classList.remove('hidden');
            document.getElementById('locationName').innerText = `${cityName.toUpperCase()} // ${country}`;
            document.getElementById('tempValue').innerText = `${Math.round(data.main.temp)}°`;
            document.getElementById('humidityValue').innerText = `${data.main.humidity}%`;
            document.getElementById('windValue').innerText = Math.round(data.wind.speed * 3.6);
            document.getElementById('visibilityValue').innerText = (data.visibility / 1000).toFixed(1);
            document.getElementById('conditionValue').innerText = data.weather[0].main;
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            const iconMap = { '01': 'fa-sun text-amber-400', '02': 'fa-cloud-sun text-emerald-400', '03': 'fa-cloud text-zinc-400', '09': 'fa-cloud-showers-heavy text-blue-400', '11': 'fa-bolt-lightning text-amber-500' };
            const prefix = data.weather[0].icon.substring(0, 2);
            document.getElementById('weatherIcon').innerHTML = `<i class="fas ${iconMap[prefix] || 'fa-cloud'}"></i>`;
        }

        function updateAQI(data) {
            const index = data.list[0].main.aqi;
            const configs = {
                1: { label: "Pure", text: "Optimal quality. Bio-systems safe.", color: "text-emerald-400" },
                2: { label: "Fair", text: "Minor particles detected.", color: "text-blue-400" },
                3: { label: "Mid", text: "Moderate pollutants in air.", color: "text-amber-400" },
                4: { label: "Poor", text: "Particulates high. Stay alert.", color: "text-orange-500" },
                5: { label: "Toxic", text: "Hazardous. Active filtration needed.", color: "text-red-500" }
            };
            const config = configs[index];
            document.getElementById('aqiValue').innerText = `LEVEL 0${index}`;
            const statusEl = document.getElementById('aqiStatus');
            statusEl.innerText = config.label;
            statusEl.className = `text-[10px] font-black uppercase bg-zinc-800 ${config.color} px-2 py-1 rounded`;
            document.getElementById('aqiDesc').innerText = config.text;
        }

        function processSafetyScore(weather, aqi) {
            let score = 100;
            const wind = weather.wind.speed * 3.6;
            const aqiIdx = aqi.list[0].main.aqi;
            
            if (wind > 30) score -= 20;
            if (aqiIdx >= 4) score -= 30;
            if (weather.weather[0].main.toLowerCase().includes('rain')) score -= 15;
            
            score = Math.max(0, score);
            document.getElementById('scoreRing').style.strokeDashoffset = 440 - (440 * score) / 100;
            document.getElementById('scoreText').innerText = score;
            
            const safetyLevel = document.getElementById('safetyLevel');
            if (score > 80) { safetyLevel.innerText = "OPTIMAL FOR OUTDOORS"; safetyLevel.className = "mt-6 text-sm font-bold text-emerald-500"; }
            else if (score > 50) { safetyLevel.innerText = "CAUTION ADVISED"; safetyLevel.className = "mt-6 text-sm font-bold text-amber-500"; }
            else { safetyLevel.innerText = "CRITICAL: STAY INDOORS"; safetyLevel.className = "mt-6 text-sm font-bold text-red-500"; }
        }

        function toggleLoading(isLoading) {
            loader.classList.toggle('hidden', !isLoading);
            btnText.classList.toggle('hidden', isLoading);
            searchBtn.disabled = isLoading;
        }

        function showError(msg) {
            const errorBox = document.getElementById('errorBox');
            document.getElementById('errorMsg').innerText = msg;
            errorBox.classList.remove('hidden');
            setTimeout(() => errorBox.classList.add('hidden'), 4000);
        }

        function hideError() { document.getElementById('errorBox').classList.add('hidden'); }
    </script>
</body>
</html>
